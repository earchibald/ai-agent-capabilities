name: Daily Research Leads

on:
  schedule:
    - cron: '0 7 * * *'  # Daily at 7am UTC
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  issues: write

jobs:
  trigger-research:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Collect agent stats
        id: stats
        run: |
          python3 -c "
          import json
          from pathlib import Path
          from datetime import datetime

          lines = []
          for p in sorted(Path('agents').glob('*/capabilities/current.json')):
              agent = p.parent.parent.name
              data = json.load(open(p))
              count = len(data.get('capabilities', []))
              updated = data.get('agent', {}).get('lastUpdated', 'unknown')
              if updated != 'unknown':
                  try:
                      dt = datetime.fromisoformat(updated.replace('Z', '+00:00'))
                      updated = dt.strftime('%Y-%m-%d')
                  except Exception:
                      pass
              lines.append(f'- {agent}: {count} capabilities (last updated: {updated})')

          result = chr(10).join(lines)

          # Use delimiter for multiline output
          import os
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'AGENT_STATS<<EOF\n{result}\nEOF\n')
          "

      - name: Create research trigger issue
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const agentStats = `${{ steps.stats.outputs.AGENT_STATS }}`;

            // Check for existing open research issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'research-leads'
            });

            // Skip if there's already an open research issue
            if (issues.data.length > 0) {
              console.log('Open research issue already exists, skipping.');
              return;
            }

            const body = `## Daily Research Prompt — ${today}\n\n` +
              `@copilot Please research new developments for all tracked AI agents ` +
              `using the \`research-leads\` skill.\n\n` +
              `### Currently tracked agents\n${agentStats}\n\n` +
              `### What to look for\n` +
              `- New or changed capabilities\n` +
              `- Version or model releases\n` +
              `- Deprecation notices\n` +
              `- New AI coding agents worth tracking\n\n` +
              `_Generated by daily-research workflow_`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Research] AI agent capability leads — ${today}`,
              body: body,
              labels: ['research-leads', 'maintenance'],
              assignees: ['copilot']
            });
