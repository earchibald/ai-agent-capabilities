name: Daily Research Leads

on:
  schedule:
    - cron: '0 7 * * *'  # Daily at 7am UTC
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Log actions without creating issues'
        type: boolean
        default: false
      skip_copilot:
        description: 'Omit copilot from issue assignees'
        type: boolean
        default: false

permissions:
  contents: read
  issues: write

jobs:
  trigger-research:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Collect agent stats
        id: stats
        run: |
          python3 -c "
          import json
          from pathlib import Path
          from datetime import datetime

          lines = []
          for p in sorted(Path('agents').glob('*/capabilities/current.json')):
              agent = p.parent.parent.name
              data = json.load(open(p))
              count = len(data.get('capabilities', []))
              updated = data.get('agent', {}).get('lastUpdated', 'unknown')
              if updated != 'unknown':
                  try:
                      dt = datetime.fromisoformat(updated.replace('Z', '+00:00'))
                      updated = dt.strftime('%Y-%m-%d')
                  except Exception:
                      pass
              lines.append(f'- {agent}: {count} capabilities (last updated: {updated})')

          result = chr(10).join(lines)

          # Use delimiter for multiline output
          import os
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'AGENT_STATS<<EOF\n{result}\nEOF\n')
          "

      - name: Create research trigger issue
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const agentStats = `${{ steps.stats.outputs.AGENT_STATS }}`;

            // Check for existing open research issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'research-leads'
            });

            // Skip if there's already an open research issue
            if (issues.data.length > 0) {
              console.log('Open research issue already exists, skipping.');
              return;
            }

            const dryRun = '${{ inputs.dry_run }}' === 'true';
            const skipCopilot = '${{ inputs.skip_copilot }}' === 'true';

            const body = `## Daily Research Prompt — ${today}\n\n` +
              `@copilot Please research new developments for all tracked AI agents ` +
              `using the \`research-leads\` skill.\n\n` +
              `### Currently tracked agents\n${agentStats}\n\n` +
              `### What to look for\n` +
              `- New or changed capabilities\n` +
              `- Version or model releases\n` +
              `- Deprecation notices\n` +
              `- New AI coding agents worth tracking\n\n` +
              `_Generated by daily-research workflow_`;

            if (dryRun) {
              console.log('DRY RUN — would create issue:');
              console.log(`  Title: [Research] AI agent capability leads — ${today}`);
              console.log(`  Labels: research-leads, maintenance`);
              console.log(`  Assignees: ${skipCopilot ? '(none)' : 'copilot'}`);
              console.log(`  Body:\n${body}`);
              return;
            }

            const issuePayload = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Research] AI agent capability leads — ${today}`,
              body: body,
              labels: ['research-leads', 'maintenance'],
            };

            if (!skipCopilot) {
              try {
                await github.rest.issues.create({ ...issuePayload, assignees: ['copilot'] });
                console.log('Issue created with copilot assignee.');
                return;
              } catch (e) {
                if (e.status === 422) {
                  console.log('copilot is not a valid assignee (422); creating issue without assignee. @copilot mention in body will still trigger it.');
                } else {
                  throw e;
                }
              }
            }

            await github.rest.issues.create(issuePayload);
            console.log('Issue created.');
