name: Daily Research Leads

on:
  schedule:
    - cron: '0 7 * * *'  # Daily at 7am UTC
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Log actions without creating issues'
        type: boolean
        default: false
      skip_copilot:
        description: 'Omit Copilot agent assignment'
        type: boolean
        default: false

permissions:
  contents: read
  issues: write

jobs:
  trigger-research:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Collect agent stats
        id: stats
        run: |
          python3 -c "
          import json
          from pathlib import Path
          from datetime import datetime

          lines = []
          for p in sorted(Path('agents').glob('*/capabilities/current.json')):
              agent = p.parent.parent.name
              data = json.load(open(p))
              count = len(data.get('capabilities', []))
              updated = data.get('agent', {}).get('lastUpdated', 'unknown')
              if updated != 'unknown':
                  try:
                      dt = datetime.fromisoformat(updated.replace('Z', '+00:00'))
                      updated = dt.strftime('%Y-%m-%d')
                  except Exception:
                      pass
              lines.append(f'- {agent}: {count} capabilities (last updated: {updated})')

          result = chr(10).join(lines)

          # Use delimiter for multiline output
          import os
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f'AGENT_STATS<<EOF\n{result}\nEOF\n')
          "

      - name: Create research trigger issue
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const agentStats = `${{ steps.stats.outputs.AGENT_STATS }}`;

            // Check for existing open research issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'research-leads'
            });

            if (issues.data.length > 0) {
              console.log('Open research issue already exists, skipping.');
              return;
            }

            const dryRun = '${{ inputs.dry_run }}' === 'true';
            const skipCopilot = '${{ inputs.skip_copilot }}' === 'true';

            const title = `[Research] AI agent capability leads — ${today}`;
            const body = `## Daily Research Prompt — ${today}\n\n` +
              `Please research new developments for all tracked AI agents ` +
              `using the \`research-leads\` skill.\n\n` +
              `### Currently tracked agents\n${agentStats}\n\n` +
              `### What to look for\n` +
              `- New or changed capabilities\n` +
              `- Version or model releases\n` +
              `- Deprecation notices\n` +
              `- New AI coding agents worth tracking\n\n` +
              `_Generated by daily-research workflow_`;

            if (dryRun) {
              console.log('DRY RUN — would create issue:');
              console.log(`  Title: ${title}`);
              console.log(`  Labels: research-leads, maintenance`);
              console.log(`  Copilot assignment: ${skipCopilot ? 'skipped' : 'via agent_assignment API'}`);
              console.log(`  Body:\n${body}`);
              return;
            }

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['research-leads', 'maintenance'],
            });

            console.log(`Issue #${issue.data.number} created: ${issue.data.html_url}`);
            core.setOutput('issue_number', issue.data.number);
            core.setOutput('skip_copilot', skipCopilot ? 'true' : 'false');

      # Assign the Copilot coding agent using the dedicated agent_assignment API.
      # Requires a PAT (COPILOT_PAT) with repo scope from a user with a Copilot seat.
      # Without this secret the step is skipped — the issue still exists for manual assignment.
      - name: Assign Copilot coding agent
        if: steps.create-issue.outputs.issue_number != '' && steps.create-issue.outputs.skip_copilot != 'true' && secrets.COPILOT_PAT != ''
        env:
          GH_TOKEN: ${{ secrets.COPILOT_PAT }}
          ISSUE_NUMBER: ${{ steps.create-issue.outputs.issue_number }}
          REPO: ${{ github.repository }}
        run: |
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${REPO}/issues/${ISSUE_NUMBER}/assignees" \
            --input - <<EOF
          {
            "assignees": ["copilot-swe-agent[bot]"],
            "agent_assignment": {
              "target_repo": "${REPO}",
              "base_branch": "main",
              "custom_instructions": "",
              "custom_agent": "",
              "model": ""
            }
          }
          EOF
          echo "Copilot coding agent assigned to issue #${ISSUE_NUMBER}."
