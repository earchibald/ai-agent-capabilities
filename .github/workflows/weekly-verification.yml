name: Weekly Source Verification

on:
  schedule:
    - cron: '0 6 * * 1'  # Monday at 6am UTC
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Skip git push and use --dry-run for fix-redirects'
        type: boolean
        default: false
      skip_copilot:
        description: 'Omit copilot from broken-source issue assignees'
        type: boolean
        default: false

permissions:
  contents: write
  issues: write

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run full source verification (pass 1 + 2)
        run: python3 framework/scripts/verify_sources.py

      - name: Auto-fix redirected URLs to canonical targets
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            python3 framework/scripts/verify_sources.py --fix-redirects --dry-run
          else
            python3 framework/scripts/verify_sources.py --fix-redirects
          fi

      - name: Commit verification results and redirect fixes
        if: ${{ inputs.dry_run != 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add agents/*/verification/*.json agents/*/capabilities/current.json
          git diff --cached --quiet || git commit -m "Weekly source verification: fix redirects + update results [automated]"
          git push

      - name: Report broken sources (404s)
        id: check_broken
        run: |
          python3 -c "
          import json, sys
          from pathlib import Path
          issues = []
          for f in sorted(Path('agents').rglob('verification/reachability.json')):
              data = json.load(open(f))
              agent = f.parent.parent.name
              seen = set()
              for r in data.get('results', []):
                  if not r.get('reachable') and r.get('error'):
                      url = r['url'].split('#')[0]
                      if url not in seen:
                          seen.add(url)
                          issues.append(f'{agent}: [{r[\"capability\"]}] {url}')
          if issues:
              print(f'BROKEN_COUNT={len(issues)}')
              print('BROKEN_URLS<<EOF')
              for i in issues:
                  print(f'  - {i}')
              print('EOF')
              sys.exit(0)
          else:
              print('BROKEN_COUNT=0')
          " >> "$GITHUB_OUTPUT" 2>&1 || true
          python3 framework/scripts/verify_sources.py --report

      - name: Open issue for broken sources and assign to Copilot
        if: ${{ steps.check_broken.outputs.BROKEN_COUNT != '0' && steps.check_broken.outputs.BROKEN_COUNT != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            const brokenCount = '${{ steps.check_broken.outputs.BROKEN_COUNT }}';
            const brokenUrls = `${{ steps.check_broken.outputs.BROKEN_URLS }}`;
            const today = new Date().toISOString().split('T')[0];

            // Build machine-readable JSON block for the skill to parse
            const brokenLines = brokenUrls.trim().split('\n')
              .filter(l => l.trim().startsWith('- '))
              .map(l => {
                const match = l.match(/^\s*-\s+(\S+):\s+\[([^\]]+)\]\s+(.+)$/);
                if (match) {
                  return JSON.stringify({agent: match[1], capability: match[2], url: match[3]});
                }
                return null;
              })
              .filter(Boolean);
            const jsonBlock = brokenLines.length > 0
              ? `<!-- BROKEN_SOURCES_JSON\n${brokenLines.join('\n')}\n-->\n\n`
              : '';

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'broken-source'
            });

            const body = jsonBlock +
              `## ${brokenCount} broken source URL(s) detected on ${today}\n\n` +
              `The weekly source verification found unreachable URLs that could not be auto-fixed.\n\n` +
              `### Broken URLs\n\`\`\`\n${brokenUrls}\n\`\`\`\n\n` +
              `### Resolution\n` +
              `@copilot Please fix these broken sources using the \`source-maintenance\` skill.\n\n` +
              `_Generated by weekly-verification workflow_`;

            const dryRun = '${{ inputs.dry_run }}' === 'true';
            const skipCopilot = '${{ inputs.skip_copilot }}' === 'true';

            if (dryRun) {
              console.log('DRY RUN â€” would create/update broken-source issue');
              console.log(`  Broken count: ${brokenCount}`);
              console.log(`  Broken URLs:\n${brokenUrls}`);
              console.log(`  Would assign copilot: ${!skipCopilot}`);
              return;
            }

            if (issues.data.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `Updated on ${today}:\n\n` + body
              });
              if (!skipCopilot) {
                await github.rest.issues.addAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issues.data[0].number,
                  assignees: ['copilot']
                });
              }
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Automated] ${brokenCount} broken source URL(s) need fixes`,
                body: body,
                labels: ['broken-source', 'maintenance'],
                assignees: skipCopilot ? [] : ['copilot']
              });
            }
