name: Weekly Source Verification

on:
  schedule:
    - cron: '0 6 * * 1'  # Monday at 6am UTC
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  issues: write

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Run full source verification (pass 1 + 2)
        run: python3 framework/scripts/verify_sources.py

      - name: Auto-fix redirected URLs to canonical targets
        run: python3 framework/scripts/verify_sources.py --fix-redirects

      - name: Commit verification results and redirect fixes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add agents/*/verification/*.json agents/*/capabilities/current.json
          git diff --cached --quiet || git commit -m "Weekly source verification: fix redirects + update results [automated]"
          git push

      - name: Report broken sources (404s)
        id: check_broken
        run: |
          python3 -c "
          import json, sys
          from pathlib import Path
          issues = []
          for f in sorted(Path('agents').rglob('verification/reachability.json')):
              data = json.load(open(f))
              agent = f.parent.parent.name
              seen = set()
              for r in data.get('results', []):
                  if not r.get('reachable') and r.get('error'):
                      url = r['url'].split('#')[0]
                      if url not in seen:
                          seen.add(url)
                          issues.append(f'{agent}: [{r[\"capability\"]}] {url}')
          if issues:
              print(f'BROKEN_COUNT={len(issues)}')
              print('BROKEN_URLS<<EOF')
              for i in issues:
                  print(f'  - {i}')
              print('EOF')
              sys.exit(0)
          else:
              print('BROKEN_COUNT=0')
          " >> "$GITHUB_OUTPUT" 2>&1 || true
          python3 framework/scripts/verify_sources.py --report

      - name: Open issue for broken sources
        if: ${{ steps.check_broken.outputs.BROKEN_COUNT != '0' && steps.check_broken.outputs.BROKEN_COUNT != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            const brokenCount = '${{ steps.check_broken.outputs.BROKEN_COUNT }}';
            const brokenUrls = `${{ steps.check_broken.outputs.BROKEN_URLS }}`;
            const today = new Date().toISOString().split('T')[0];

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'broken-source'
            });

            const body = `## ${brokenCount} broken source URL(s) detected on ${today}\n\n` +
              `The weekly source verification found unreachable URLs that could not be auto-fixed (not simple redirects).\n\n` +
              `### Broken URLs\n\`\`\`\n${brokenUrls}\n\`\`\`\n\n` +
              `### Resolution\n` +
              `1. Find the replacement URLs for each broken source\n` +
              `2. Create a \`fixes.json\` file: \`{"old_url": "new_url", ...}\`\n` +
              `3. Run: \`python3 framework/scripts/verify_sources.py --apply-fixes fixes.json\`\n` +
              `4. Re-run verification to confirm: \`python3 framework/scripts/verify_sources.py\`\n` +
              `5. Commit and push\n\n` +
              `_Generated by weekly-verification workflow_`;

            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `Updated on ${today}:\n\n` + body
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[Automated] ${brokenCount} broken source URL(s) need manual fixes`,
                body: body,
                labels: ['broken-source', 'maintenance']
              });
            }
